<!DOCTYPE html>
<html>
<head>
    <title>Cart Quick Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-btn { background: #4CAF50; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; white-space: pre-line; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>üõí Cart Quick Test & Fix</h1>
    
    <h3>Step 1: Test Basic Servlet Connection</h3>
    <button class="test-btn" onclick="testServlets()">Test Cart & Order Servlets</button>
    <div id="servletResult" class="result"></div>
    
    <h3>Step 2: Quick Login</h3>
    <button class="test-btn" onclick="quickLogin()">Login as testuser</button>
    <div id="loginResult" class="result"></div>
    
    <h3>Step 3: Test Cart Operations</h3>
    <button class="test-btn" onclick="addToCart()">Add Tomatoes to Cart</button>
    <button class="test-btn" onclick="viewCart()">View Cart</button>
    <button class="test-btn" onclick="clearCart()">Clear Cart</button>
    <div id="cartResult" class="result"></div>
    
    <h3>Step 4: Open Main Site</h3>
    <button class="test-btn" onclick="openMain()">Open Enhanced Garden E-Commerce</button>
    
    <script>
        let currentUser = null;
        
        function testServlets() {
            const resultDiv = document.getElementById('servletResult');
            resultDiv.innerHTML = 'Testing servlets...';
            
            Promise.all([
                fetch('/gar/CartServlet').then(r => ({name: 'Cart', status: r.status, ok: r.ok})),
                fetch('/gar/OrderServlet').then(r => ({name: 'Order', status: r.status, ok: r.ok})),
                fetch('/gar/LoginServlet').then(r => ({name: 'Login', status: r.status, ok: r.ok}))
            ]).then(results => {
                let html = 'Servlet Test Results:\n';
                results.forEach(result => {
                    html += `${result.name}Servlet: ${result.ok ? '‚úÖ' : '‚ùå'} Status ${result.status}\n`;
                });
                resultDiv.innerHTML = html;
                resultDiv.className = 'result success';
            }).catch(error => {
                resultDiv.innerHTML = `‚ùå Servlet test failed: ${error}`;
                resultDiv.className = 'result error';
            });
        }
        
        function quickLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = 'Logging in...';
            
            fetch('/gar/LoginServlet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'username=testuser&password=test123'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentUser = {
                        id: data.user_id,
                        username: data.username,
                        fullName: data.full_name
                    };
                    resultDiv.innerHTML = `‚úÖ Login successful!\nUser ID: ${data.user_id}\nUsername: ${data.username}\nFull Name: ${data.full_name}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `‚ùå Login failed: ${data.message}`;
                    resultDiv.className = 'result error';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `‚ùå Login error: ${error}`;
                resultDiv.className = 'result error';
            });
        }
        
        function addToCart() {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }
            
            const resultDiv = document.getElementById('cartResult');
            resultDiv.innerHTML = 'Adding to cart...';
            
            fetch('/gar/CartServlet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'action=add&product_id=1&quantity=2'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `‚úÖ Added to cart successfully!\nMessage: ${data.message}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `‚ùå Failed to add to cart: ${data.message}`;
                    resultDiv.className = 'result error';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `‚ùå Add to cart error: ${error}`;
                resultDiv.className = 'result error';
            });
        }
        
        function viewCart() {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }
            
            const resultDiv = document.getElementById('cartResult');
            resultDiv.innerHTML = 'Loading cart...';
            
            fetch('/gar/CartServlet')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `‚úÖ Cart loaded successfully!\n`;
                    html += `Item Count: ${data.item_count || 0}\n`;
                    html += `Total Amount: ‚Çπ${data.total_amount || 0}\n\n`;
                    
                    if (data.cart_items && data.cart_items.length > 0) {
                        html += 'Cart Items:\n';
                        data.cart_items.forEach(item => {
                            html += `‚Ä¢ ${item.name} - ‚Çπ${item.price} √ó ${item.quantity} = ‚Çπ${item.total}\n`;
                        });
                        html += `\nüõí PROCEED TO CHECKOUT button should appear with these items!`;
                    } else {
                        html += 'Cart is empty.';
                    }
                    
                    resultDiv.innerHTML = html;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `‚ùå Failed to load cart: ${data.message}`;
                    resultDiv.className = 'result error';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `‚ùå Cart view error: ${error}`;
                resultDiv.className = 'result error';
            });
        }
        
        function clearCart() {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }
            
            fetch('/gar/CartServlet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'action=clear'
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('cartResult');
                if (data.success) {
                    resultDiv.innerHTML = '‚úÖ Cart cleared successfully!';
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `‚ùå Failed to clear cart: ${data.message}`;
                    resultDiv.className = 'result error';
                }
            })
            .catch(error => {
                document.getElementById('cartResult').innerHTML = `‚ùå Clear cart error: ${error}`;
            });
        }
        
        function openMain() {
            window.open('/gar/enhanced-garden-ecommerce/', '_blank');
        }
    </script>
</body>
</html>
